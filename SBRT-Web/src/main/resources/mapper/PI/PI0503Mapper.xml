<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.tracom.bms.domain.PI0503.PI0503Mapper">
	<select id="PI0503G0R0" resultType="Map">
		SELECT  	 A.ORGA_ID
					,A.ORGA_NM
					,A.REMARK
					,COUNT(A.ORGA_ID) VIDEO_COUNT
					,SUM(C.PLAY_TM) TOTAL_TIME
				
		FROM 	 	 BMS_VDO_ORGA_INFO A
		LEFT JOIN 	 BMS_VDO_ORGA_LIST B
		ON		 	 A.ORGA_ID = B.ORGA_ID	
		LEFT JOIN	 BMS_VDO_INFO C
		ON   	     B.VDO_ID = C.VDO_ID
		GROUP BY 	 A.ORGA_ID

		<where>
			<if test="TYPE == 'ALL' and CONTENT != null and CONTENT != ''">
				AND ORGA_ID LIKE CONCAT('%',#{CONTENT},'%') || ORGA_NM LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
			<if test="TYPE == 'ORGA_ID'">
				AND ORGA_ID LIKE CONCAT('%',#{CONTENT},'%')
			</if>
			<if test="TYPE == 'ORGA_NM'">
				AND ORGA_NM LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
		</where>
	</select>	

	<select id="PI0503SHI0" resultType="Map">
		SELECT  VHC_ID, VHC_NO
		FROM BMS_VHC_MST
	</select>

	<select id="PI0503G1R0" resultType="Map">
		select	a.VHC_ID,
				VHC_NO,
				RSV_ID,
				a.MNG_ID,
				DATE_FORMAT(RSV_DT, '%Y%m%d') RSV_DT,
				ORGA_ID,
				DVC_KIND,
				INST_LOC,
				DVC_ID,
				(CASE WHEN RSV_ID IS NOT NULL THEN '예약중' END) AS RSV_STATE
		from BMS_DVC_INFO a LEFT JOIN BMS_VHC_MST b 
		on a.VHC_ID = b.VHC_ID LEFT JOIN BMS_VDO_RSV_INFO c
		on a.MNG_ID = c.MNG_ID
		
		WHERE	DVC_KIND = 'DK003'
		order by a.VHC_ID		
	</select>
	
	<insert id="PI0503G1I0" parameterType="Map">	
	
		<selectKey keyProperty="RSV_ID" resultType="String" order="BEFORE">
    		SELECT CONCAT('VR', LPAD(NEXTVAL(SEQ_BMS_VDO_RSV_INFO_0), 8, '0')) AS RSV_ID
    	</selectKey>
	
		insert into BMS_VDO_RSV_INFO
				(
					RSV_ID,
					MNG_ID,
					RSV_DT,
					ORGA_ID,
					UPD_DTM,
					UPD_ID
				)	
				   
		values (
					#{RSV_ID},
					#{MNG_ID},
					STR_TO_DATE(#{RSV_DT}, '%Y%m%d'),
					#{ORGA_ID},
					#{UPD_DTM},
					#{SSN_USER_ID}
				)
	</insert>
	
	
	<insert id="PI0503G1I1" parameterType="Map">
		INSERT INTO
			BMS_VDO_RSV_RST_INFO(
				  RSV_ID
				, MNG_ID
				, COMPLETE_YN
				)
			VALUES(
				#{RSV_ID}
				, #{MNG_ID}
				, 'N'
			)
	</insert>	

<!-- 	<update id="PI0503G1U0" parameterType="Map">
		update BMS_VHC_MST
		set 	COMP_ID = #{COMP_ID},
				AREA = #{AREA},
				VHC_NO = #{VHC_NO},
				CHAS_NO = #{CHAS_NO},
				MAKER = #{MAKER},
				RELS_DT = STR_TO_DATE(#{RELS_DT}, '%Y%m%d'),
				MODEL_NM = #{MODEL_NM},
				VHC_KIND = #{VHC_KIND},
				ROUT_DIV = #{ROUT_DIV},
				VHC_TYPE = #{VHC_TYPE},
				VHC_FUEL = #{VHC_FUEL},
				VHC_STS = #{VHC_STS},
				PSG_CNT = #{PSG_CNT},
				SPARE_YN = #{SPARE_YN},
				SCRAP_YN = #{SCRAP_YN},
				APPL_ST_DT = STR_TO_DATE(#{APPL_ST_DT}, '%Y%m%d'),
				APPL_ED_DT = STR_TO_DATE(#{APPL_ED_DT}, '%Y%m%d'),
				USE_YN = #{USE_YN},
				REMARK = #{REMARK},
				UPD_DTM = #{UPD_DTM}
		where VHC_ID = #{VHC_ID}
	</update> -->
	
	<delete id="PI0503G1D0" parameterType="Map">
		delete
		from BMS_VDO_RSV_INFO
		where RSV_ID = #{RSV_ID}
	</delete>
	
	
	<select id="makePlayList" parameterType="String" resultType="Map">
		SELECT
			  IF(VINFO.FILE_TYPE = 'FT001', 'V', 'I') AS VIDEO_TYPE
			, IF(VINFO.FILE_TYPE = 'FT001', CONCAT(VINFO.VDO_ID, '.mp4'), CONCAT(VINFO.VDO_ID, '.jpg')) AS VIDEO_FILE
			, DATE_FORMAT(VINFO.PLAY_ST_DT, '%Y%m%d') AS PLAY_ST_DT
			, DATE_FORMAT(VINFO.PLAY_ED_DT, '%Y%m%d') AS PLAY_ED_DT
			, VINFO.IMG_PLAY_TM AS RUN_TIME
		FROM
			BMS_VDO_ORGA_LIST OLIST
			LEFT JOIN BMS_VDO_INFO VINFO ON OLIST.VDO_ID = VINFO.VDO_ID
		WHERE
			OLIST.ORGA_ID = #{orgaId}
		ORDER BY OLIST.SN
	</select>	


</mapper>