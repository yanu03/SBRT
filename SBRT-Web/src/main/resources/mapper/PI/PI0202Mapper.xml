<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.tracom.bms.domain.PI0202.PI0202Mapper">

	<select id="PI0202SHI0" resultType="Map">
		select 
			ROUT_ID
			,ROUT_NM
			,REP_ROUT_NM
		from 
			BMS_ROUT_MST
	</select>
	
	<select id="PI0202G1R0" resultType="Map">
		SELECT A.ROUT_ID, A.NODE_ID, A.NODE_SN, A.NODE_NM, A.NODE_TYPE, A.LINK_ID, A.STTN_ID, A.STTN_NO, A.CRS_ID, A.ORGA_ID
				,A.GPS_X, A.GPS_Y, A.LINK_NODE_YN, A.NODE_SN AS OLD_NODE_SN, B.MORN_STD, C.ALL_PLAY_TM
		FROM BMS_ROUT_NODE_CMPSTN A
			INNER JOIN BMS_ROUT_MST R ON A.ROUT_ID = R.ROUT_ID AND R.DEL_YN !='Y'
			LEFT OUTER JOIN BMS_ROUT_LINK_CMPSTN B ON A.ROUT_ID = B.ROUT_ID AND A.LINK_ID = B.LINK_ID
			LEFT OUTER JOIN BMS_VOC_ORGA_INFO C ON A.ORGA_ID = C.ORGA_ID
		WHERE A.ROUT_ID  = #{ROUT_ID}
		<!-- <if test="@kr.tracom.util.CommonUtil@notEmpty(CONTENT)">
			<if test="TYPE == 'ALL'">
				AND (A.NODE_ID LIKE CONCAT('%',#{CONTENT},'%') || A.NODE_NM LIKE CONCAT('%',#{CONTENT},'%'))
			</if>
			<if test="TYPE == 'NODE_ID'">
				A.NODE_ID LIKE CONCAT('%',#{CONTENT},'%')
			</if>
			<if test="TYPE == 'NODE_NM'">
				A.NODE_NM LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
		</if> -->
		 ORDER BY NODE_SN
	</select>

	<select id="PI0202G1K0" resultType="Map">
		SELECT CONCAT('ND', LPAD(NEXTVAL(SEQ_BMS_NODE_MST_0), 8, '0')) AS 'SEQ'
	</select>
  
	<insert id="PI0202G1I0" parameterType="Map">
		INSERT INTO BMS_NODE_MST
			(NODE_ID,NODE_NM,NODE_TYPE,GPS_X, GPS_Y,UPD_DTM,UPD_ID)
		VALUES (#{NODE_ID}, #{NODE_NM}, #{NODE_TYPE}, #{GPS_X}, #{GPS_Y}, #{UPD_DTM}, #{SSN_USER_ID})
		ON DUPLICATE KEY UPDATE
			NODE_NM		= VALUES(NODE_NM)
			, NODE_TYPE	= VALUES(NODE_TYPE)
			, GPS_X	= VALUES(GPS_X)
			, GPS_Y	= VALUES(GPS_Y)
			, USE_YN		= 'Y'
			, UPD_DTM		= VALUES(UPD_DTM)
			, UPD_ID		= VALUES(UPD_ID);

		INSERT INTO BMS_ROUT_NODE_CMPSTN
			(ROUT_ID,NODE_ID,NODE_SN,NODE_NM,NODE_TYPE,LINK_ID,STTN_ID,STTN_NO,CRS_ID,ORGA_ID,GPS_X,GPS_Y,LINK_NODE_YN,UPD_DTM,UPD_ID)
		VALUES(#{ROUT_ID},#{NODE_ID},#{NODE_SN},#{NODE_NM},#{NODE_TYPE},#{LINK_ID},#{STTN_ID},#{STTN_NO},#{CRS_ID},#{ORGA_ID},#{GPS_X},#{GPS_Y},#{LINK_NODE_YN},#{UPD_DTM},#{SSN_USER_ID})
		ON DUPLICATE KEY UPDATE
			NODE_NM		= VALUES(NODE_NM)
			, NODE_TYPE	= VALUES(NODE_TYPE)
			, LINK_ID	= VALUES(LINK_ID)
			, STTN_ID	= VALUES(STTN_ID)
			, STTN_NO	= VALUES(STTN_NO)
			, CRS_ID	= VALUES(CRS_ID)
			, ORGA_ID	= VALUES(ORGA_ID)
			, GPS_X	= VALUES(GPS_X)
			, GPS_Y	= VALUES(GPS_Y)
			, LINK_NODE_YN	= VALUES(LINK_NODE_YN)
			, UPD_DTM		= VALUES(UPD_DTM)
			, UPD_ID		= VALUES(UPD_ID);
		
		UPDATE BMS_VOC_ORGA_INFO SET GPS_X = #{GPS_X}, GPS_Y = #{GPS_Y}
		WHERE ORGA_ID = #{ORGA_ID};
	</insert>

	<insert id="PI0202G1U0" parameterType="Map">
		UPDATE BMS_NODE_MST
			SET NODE_NM = #{NODE_NM}, NODE_TYPE = #{NODE_TYPE}, GPS_X = #{GPS_X}, GPS_Y = #{GPS_Y}, UPD_DTM= #{UPD_DTM}, UPD_ID= #{SSN_USER_ID}
		WHERE NODE_ID= #{NODE_ID};
	
		UPDATE BMS_ROUT_NODE_CMPSTN
			SET NODE_SN= #{NODE_SN}, NODE_NM = #{NODE_NM}, NODE_TYPE = #{NODE_TYPE}, STTN_ID= #{STTN_ID}, STTN_NO= #{STTN_NO}, CRS_ID= #{CRS_ID}, ORGA_ID= #{ORGA_ID}
				,GPS_X = #{GPS_X}, GPS_Y = #{GPS_Y}, LINK_NODE_YN=#{LINK_NODE_YN}, UPD_DTM= #{UPD_DTM}, UPD_ID= #{SSN_USER_ID}
		WHERE ROUT_ID= #{ROUT_ID} AND NODE_ID= #{NODE_ID} AND NODE_SN= #{OLD_NODE_SN};
		
		UPDATE BMS_VOC_ORGA_INFO SET GPS_X = #{GPS_X}, GPS_Y = #{GPS_Y}
		WHERE ORGA_ID = #{ORGA_ID};
	
	</insert>

	<delete id="PI0202G1D0" parameterType="Map">
		DELETE FROM BMS_ROUT_NODE_CMPSTN
		WHERE ROUT_ID = #{ROUT_ID} 
		AND NODE_ID = #{NODE_ID}
		AND NODE_SN= #{OLD_NODE_SN};
	
		UPDATE BMS_NODE_MST SET USE_YN='N'
		WHERE NODE_ID = #{NODE_ID};
	</delete>

	<select id="PI0202P0R0" resultType="Map" parameterType="Map">
		SELECT ORGA_ID, ORGA_NM, ALL_PLAY_TM, REMARK FROM BMS_VOC_ORGA_INFO
		<where>
			<if test="@kr.tracom.util.CommonUtil@notEmpty(CONTENT)">
					ORGA_ID LIKE CONCAT('%',#{CONTENT},'%') || ORGA_NM LIKE CONCAT('%',#{CONTENT},'%')
			</if>
		</where>
		ORDER BY ORGA_ID
	</select>		
	
</mapper>