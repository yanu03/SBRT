<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.tracom.bms.domain.PI0100.PI0100Mapper">

	<select id="PI0100G0R0" resultType="Map" parameterType="Map">
		SELECT NOTICE_ID, VHC_RCPT_IDS, STTN_RCPT_IDS, TITLE, SEND_DIV,
		 SEND_STS, DATE_FORMAT(REG_DTM, '%Y%m%d%H%i') REG_DTM, DATE_FORMAT(RSV_DTM, '%Y%m%d%H%i') RSV_DTM, DATE_FORMAT(SEND_DTM, '%Y%m%d%H%i') SEND_DTM, DATE_FORMAT(UPD_DTM, '%Y%m%d%H%i') UPD_DTM, CONTENTS, UPD_ID FROM BMS_NOTICE_MST
		<where>
			<if test="SContent != ''">
				TITLE LIKE CONCAT('%',#{SContent},'%') OR CONTENTS LIKE CONCAT('%',#{SContent},'%') 
			</if>
		</where>
	</select>
	
	<select id="PI0100G1R0" resultType="Map" parameterType="Map">
		SELECT VHC_ID, VHC_NO, CHAS_NO, COMP_NM, V.COMP_ID, V.AREA
		FROM BMS_VHC_MST V, BMS_TRANSCOMP_MST T
		<where>
			<foreach collection="VHC_RCPT_IDS" item="item" separator=" OR "> (VHC_ID = #{item} AND V.COMP_ID = T.COMP_ID)</foreach>
		</where>
	</select>
	
	<select id="PI0100G2R0" resultType="Map" parameterType="Map">
		SELECT STTN_ID, STTN_NM, STTN_NO, GPS_X, GPS_Y 
		FROM BMS_STTN_MST
		<where>
			<foreach collection="STTN_RCPT_IDS" item="item" separator=" OR "> (STTN_ID = #{item})</foreach>
		</where>		
	</select>

	<select id="PI0100P0R0" resultType="Map" parameterType="Map">
		SELECT VHC_ID, VHC_NO, CHAS_NO, COMP_NM, V.AREA FROM BMS_VHC_MST V, BMS_TRANSCOMP_MST T 
		WHERE V.COMP_ID = T.COMP_ID AND V.VHC_ID NOT IN (SELECT V.VHC_ID FROM BMS_VHC_MST V, BMS_TRANSCOMP_MST T
		<where>
			<foreach collection="VHC_RCPT_IDS" item="item" separator=" OR "> V.COMP_ID = T.COMP_ID AND VHC_ID = #{item}</foreach>
		</where>
		)
		<if test="TYPE == 'VHC_NO'">
			AND VHC_NO LIKE CONCAT('%',#{CONTENT},'%')
		</if>
		<if test="TYPE == 'CHAS_NO'">
			AND CHAS_NO LIKE CONCAT('%',#{CONTENT},'%')
		</if>
		ORDER BY VHC_ID		
	</select>
	
	<select id="PI0100P1R0" resultType="Map" parameterType="Map">
		SELECT STTN_ID, STTN_NM, STTN_NO, GPS_X, GPS_Y FROM BMS_STTN_MST 
		WHERE STTN_ID NOT IN (SELECT STTN_ID FROM BMS_STTN_MST WHERE 
		<foreach collection="STTN_RCPT_IDS" item="item" separator=" OR "> STTN_ID = #{item}</foreach>
		)
		<if test="TYPE == 'STTN_NM'">
			AND STTN_NM LIKE CONCAT('%',#{CONTENT},'%')
		</if>
		<if test="TYPE == 'STTN_NO'">
			AND STTN_NO LIKE CONCAT('%',#{CONTENT},'%')
		</if>
		ORDER BY STTN_ID
	</select>

	
	<insert id="PI0100G0I0" parameterType="Map">
		<selectKey keyProperty="NOTICE_ID" resultType="String" order="BEFORE">
	          SELECT CONCAT('NO', LPAD(NEXTVAL(SEQ_BMS_NOTICE_MST_0), 8, '0'))
		</selectKey>	
		INSERT INTO BMS_NOTICE_MST(NOTICE_ID, VHC_RCPT_IDS, STTN_RCPT_IDS, TITLE, SEND_DIV, SEND_STS, REG_DTM, RSV_DTM, SEND_DTM, UPD_DTM, CONTENTS, UPD_ID) 
		VALUES (#{NOTICE_ID}, #{VHC_RCPT_IDS}, #{STTN_RCPT_IDS}, #{TITLE}, #{SEND_DIV}, #{SEND_STS}, STR_TO_DATE(#{REG_DTM}, '%Y%m%d%H%i'), STR_TO_DATE(#{RSV_DTM}, '%Y%m%d%H%i'), STR_TO_DATE(#{SEND_DTM}, '%Y%m%d%H%i'), #{UPD_DTM}, #{CONTENTS}, #{UPD_ID})
	</insert>

	<delete id="PI0100G0D0" parameterType="Map">
		DELETE FROM BMS_NOTICE_MST WHERE NOTICE_ID = #{NOTICE_ID}
	</delete>
	
	<update id="PI0100G0U0" parameterType="Map">
		UPDATE BMS_NOTICE_MST SET VHC_RCPT_IDS = #{VHC_RCPT_IDS}, STTN_RCPT_IDS = #{STTN_RCPT_IDS}, TITLE = #{TITLE}, SEND_DIV = #{SEND_DIV}, 
		SEND_STS = #{SEND_STS}, REG_DTM = STR_TO_DATE(#{REG_DTM}, '%Y%m%d%H%i'), RSV_DTM = STR_TO_DATE(#{RSV_DTM}, '%Y%m%d%H%i'), SEND_DTM = STR_TO_DATE(#{SEND_DTM}, '%Y%m%d%H%i'), UPD_DTM = #{UPD_DTM}, CONTENTS = #{CONTENTS}, UPD_ID = #{UPD_ID}
		WHERE NOTICE_ID = #{NOTICE_ID}
	</update>
</mapper>