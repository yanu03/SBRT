<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.tracom.bms.domain.PI0603.PI0603Mapper">
	<select id="PI0603G0R0" resultType="Map">
		SELECT  	 A.ORGA_ID
					,A.ORGA_NM
					,A.REMARK
					,COUNT(A.ORGA_ID) VIDEO_COUNT
					,SUM(C.PLAY_TM) TOTAL_TIME
				
		FROM 	 	 BMS_BIT_VDO_ORGA_INFO A
		LEFT JOIN 	 BMS_BIT_VDO_ORGA_LIST B
		ON		 	 A.ORGA_ID = B.ORGA_ID	
		LEFT JOIN	 BMS_BIT_VDO_INFO C
		ON   	     B.VDO_ID = C.VDO_ID

		<where>
			<if test="TYPE == 'ALL' and CONTENT != null and CONTENT != ''">
				AND A.ORGA_ID LIKE CONCAT('%',#{CONTENT},'%') || A.ORGA_NM LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
			<if test="TYPE == 'ORGA_ID'">
				AND A.ORGA_ID LIKE CONCAT('%',#{CONTENT},'%')
			</if>
			<if test="TYPE == 'ORGA_NM'">
				AND A.ORGA_NM LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
		</where>
		GROUP BY 	 A.ORGA_ID		
	</select>	

	<select id="PI0603SHI0" resultType="Map">
		SELECT		 ORGA_ID
					,ORGA_NM
		FROM	     BMS_BIT_VDO_ORGA_INFO
	</select>

	<select id="PI0603G1R0" resultType="Map">
		SELECT	  	 A.FCLT_ID
					,A.NODE_ID
					,B.NODE_NM
					,A.FCLT_KIND
					,A.FCLT_TYPE
					,A.INST_LOC
					,A.MNG_ID
					,(CASE WHEN C.RSV_ID IS NOT NULL THEN '예약중' END) RSV_STATE
					,C.RSV_ID
					,DATE_FORMAT(C.RSV_DT, '%Y%m%d') RSV_DT
		
		FROM 		BMS_FCLT_INFO A 
		LEFT JOIN 	BMS_NODE_MST B
		ON 			A.NODE_ID = B.NODE_ID
		LEFT JOIN	BMS_BIT_VDO_RSV_INFO C
		ON			A.MNG_ID = C.MNG_ID
		
		<where>
			<if test="CONTENT != null and CONTENT != ''">
				AND B.NODE_NM LIKE CONCAT('%',#{CONTENT},'%')
			</if>
		</where>		
		
		ORDER BY	A.NODE_ID		
	</select>
	
	<insert id="PI0603G1I0" parameterType="Map">
		INSERT INTO BMS_BIT_VDO_RSV_INFO
				(
					RSV_ID
				    ,MNG_ID
					,RSV_DT
					,ORGA_ID
					,UPD_DTM
					,UPD_ID
				)	
				   
		values (
					(
						SELECT CONCAT('RS', LPAD(NEXTVAL(SEQ_BMS_BIT_VDO_RSV_INFO_0), 8, '0')) AS RSV_ID
					) 
					,#{MNG_ID}
					,STR_TO_DATE(#{RSV_DT}, '%Y%m%d')
					,#{ORGA_ID}
					,#{UPD_DTM}
					,#{SSN_USER_ID}
				)
	</insert>

<!-- 	<update id="PI0603G1U0" parameterType="Map">
		update BMS_BIT_VHC_MST
		set 	COMP_ID = #{COMP_ID},
				AREA = #{AREA},
				VHC_NO = #{VHC_NO},
				CHAS_NO = #{CHAS_NO},
				MAKER = #{MAKER},
				RELS_DT = STR_TO_DATE(#{RELS_DT}, '%Y%m%d'),
				MODEL_NM = #{MODEL_NM},
				VHC_KIND = #{VHC_KIND},
				ROUT_DIV = #{ROUT_DIV},
				VHC_TYPE = #{VHC_TYPE},
				VHC_FUEL = #{VHC_FUEL},
				VHC_STS = #{VHC_STS},
				PSG_CNT = #{PSG_CNT},
				SPARE_YN = #{SPARE_YN},
				SCRAP_YN = #{SCRAP_YN},
				APPL_ST_DT = STR_TO_DATE(#{APPL_ST_DT}, '%Y%m%d'),
				APPL_ED_DT = STR_TO_DATE(#{APPL_ED_DT}, '%Y%m%d'),
				USE_YN = #{USE_YN},
				REMARK = #{REMARK},
				UPD_DTM = #{UPD_DTM}
		where VHC_ID = #{VHC_ID}
	</update> -->
	
	<delete id="PI0603G1D0" parameterType="Map">
		DELETE
		FROM 		BMS_BIT_VDO_RSV_INFO
		WHERE		RSV_ID = #{RSV_ID}
	</delete>


</mapper>